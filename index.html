<!DOCTYPE html>
<html>
    <head>
        <title>Archy</title>
        <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    </head>

    <body>
        <div id="bow">
            <img id="bowSprite" src="ship.gif" />
        </div><br/>

        <img id="bullet" src="bullet.png" hidden />

        <div id="score">
            <h1>0</h1>
        </div>

        <div id="platform" align="center">
            <h2>_______</h2>
        </div>

        <script>
            $(function() {
                // Center elements (absolute)
                $.fn.centerWidth = function() {
                    this.css('left',
                        $(window).width() / 2 -
                        $(this).width() / 2);
                };

                $.fn.centerHeight = function() {
                    this.css('top',
                        $(window).height() / 2 -
                        $(this).height() / 2);
                };

                // Initializations
                $("#score").centerHeight();
                $("#score").centerWidth();
                $("#highScore").centerHeight();
                $("#platform").centerWidth();

                // Wakaranakutemoii
                var stayInPlace = 999999;

                var bowJs = document.getElementById("bow");
                var bow = $("#bow");
                var bowSprite = $("#bowSprite");

                var bulletJs = document.getElementById("bullet");
                var bullet = $("#bullet");
                var bulletSpeed = 1000;
                var bulletFired = false;
                var score = 0;

                var platformJs = document.getElementById("platform");
                var platform = $("#platform");
                var platformLeft;
                var platformRight;
                var platformSpeed = stayInPlace;

                var animDone = true;

                var min = 0;
                var max = $(window).width();
                var height = $(window).height();

                // High score
                if(window.localStorage.getItem("highScore") == null) {
                    window.localStorage.setItem("highScore", 0);
                }

                // Bow movement
                setInterval(function() {
                    bow.animate({
                        left: "+=" + (max - (bow.width() * 2)) + "px"
                    }, 5000);

                    bow.animate({
                        left: "-=" + (max - (bow.width() * 2)) + "px"
                    }, 5000);
                }, 0);

                setInterval(function() {
                    if(animDone && platformSpeed != stayInPlace) {
                        animDone = false;

                        platform.animate({
                            left: (max - (platform.width())) + "px"
                        }, platformSpeed, function() {
                            animDone = true;
                        });

                        animDone = false;

                        platform.animate({
                            left: 0 + "px"
                        }, platformSpeed, function() {
                            animDone = true;
                        });
                    }
                }, 0);

                // On tap handle
                $(document).on('click', function() {
                    game();
                });

                document.body.onkeydown = function(e) {
                    if(e.keyCode == 32) {
                        game();
                    }
                }

                function game() {
                    // Only fire if no recent projectile
                    if(!bulletFired) {
                        // Spawn bullet
                        bullet.show();
                        bulletFired = true;

                        // Execute after hitting the other edge
                        setTimeout(function() {
                            bullet.hide();
                            bullet.animate({
                                top: "-=" + height + "px"
                            }, 0);

                            // Bullet collision checks
                            platformLeft = window.getComputedStyle(platformJs).left;
                            platformRight = parseInt(platformLeft) + platform.width() + "px";

                            if(bulletJs.style.left > platformLeft && bulletJs.style.left < platformRight) {
                                // Hit
                                score += 10
                                $("#score").html("<h1>" + score + "</h1>")
                                $('#score').centerWidth();

                                switch(score) {
                                    case 30:
                                        platformSpeed = 10000;
                                        break;
                                    case 100:
                                        platformSpeed = 8000;
                                        break;
                                    case 150:
                                        platformSpeed = 5000;
                                        break;
                                    case 250:
                                        platformSpeed = 4000;
                                        break;
                                    case 300:
                                        platformSpeed = 3000;
                                        break;
                                    case 500:
                                        platformSpeed = 1500;
                                        break;
                                }
                            } else {
                                score -= 50;
                                $("#score").html("<h1>" + score + "</h1>")
                                $('#score').centerWidth();

                                if(score <= 0) {
                                    window.location.reload();
                                }
                            }

                            bulletFired = false;
                        }, bulletSpeed);

                        // Move projectile in the middle of the bow
                        bullet.css({left: parseInt(bowJs.style.left) + 10 + "px"});

                        bullet.animate({
                            top: "+=" + height + "px"
                        }, bulletSpeed);
                    }
                }
            });
        </script>

        <style>
            @font-face {
                font-family: pixel;
                src: url(pixel.ttf);
            }

            body {
                font-family: pixel;
                color: gray;
                overflow: hidden;
            }

            #highScore {
                position: relative;
            }

            #bow {
                position: absolute;
            }

            #bowSprite {
                height: 30px;
            }

            #bullet {
                position: absolute;
                height: 10px;
            }

            #platform {
                position: absolute;
                top: 90%;
            }

            #score {
                position: absolute;
                z-index: -1;
                font-size: 300%;
            }
        </style>
    </body>
</html>
